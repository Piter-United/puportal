app = angular.module("app")

app.directive "mainMenu", ["$timeout", "Auth", "$window", ($timeout, Auth, $window)->
  restrict: "A"
  template: JST["views/shared/menu"]
  scope: false
  link: (scope, element, attrs) ->
    scope.items = []
    #scope.items.push display: "О нас", href: "#/"
    scope.items.push display: "События", href: "#/events"
    scope.items.push display: "Сообщества", href: "#/communities"
    #scope.items.push display: "Locations", href: "#/communities"
    #scope.items.push display: "Persons",   href: "#/communities"

    scope.isAuthenticated = ()->
      Auth.isAuthenticated()

    scope.logout = ()->
      config = headers:
        "X-HTTP-Method-Override": "POST"
      Auth.logout(config)

    navbartop = $("nav.navbar").offset().top

    change_docked = ()->
      if navbartop > $(window).scrollTop()
        $("body").removeClass("has-docked-nav")
      else
        $("body").addClass("has-docked-nav")

    calculateCurrent = (menu_items)->
      candidats = []
      for x in menu_items
        delete x.active
        if window.location.href.indexOf(x.href) > -1
          candidats.push(x)
      active = candidats.sort((x,y)-> y.href.localeCompare(x.href))[0]
      active && active.active = true

    scope.$on "$locationChangeSuccess", (event, xhr, deferred)->
      calculateCurrent(scope.items)

    scope.$on "devise:login", (event, xhr, deferred)->
      calculateCurrent(scope.items)

    scope.$on "devise:new-session", (event, xhr, deferred)->
      calculateCurrent(scope.items)

    scope.$on "devise:unauthorized", (event, xhr, deferred)->
      calculateCurrent(scope.items)

    $timeout ->
      #$(window).on 'scroll', change_docked
      #$(window).on 'resize', change_docked
      calculateCurrent(scope.items)
]